<?xml version="1.0" encoding="UTF-8" ?>
<ruleset
  name="Metadata XML Category"
  xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.sourceforge.io/ruleset_2_0_0.xsd"
>

    <description>
       These are custom rules that are scanning the XML metadata (not Apex classes but everyting else) making sure we are enforcing best practices
    </description>

    <!-- Your rules will come here -->

    <!-- CUSTOM SF METADATA RULES -->

    <rule
    name="NoUnderscoresInFieldNames"
    language="xml"
    message="Custom fields should not contain underscores."
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                    //CustomField/fullName/text[matches(@Image, ".*_.*__c")]
                ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="CustomFieldNamingConvention"
    language="xml"
    message="Incorrectly named field"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
//CustomField[
     (fullName/text[not(matches(@Image, "chk_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="Checkbox"]) or
     (fullName/text[not(matches(@Image, "txt_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="Text"]) or
     (fullName/text[not(matches(@Image, "txa_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="Textarea"]) or
     (fullName/text[not(matches(@Image, "txr_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="Richtext"]) or
     (fullName/text[not(matches(@Image, "txl_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="LongTextArea"]) or
     (fullName/text[not(matches(@Image, "num_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="Number"]) or
     (fullName/text[not(matches(@Image, "dat_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="Date"]) or
     (fullName/text[not(matches(@Image, "lkp_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="Lookup"]) or
     (fullName/text[not(matches(@Image, "mdr_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="MasterDetail"]) or
     (fullName/text[not(matches(@Image, "dtm_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="DateTime"]) or
     (fullName/text[not(matches(@Image, "url_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="Url"]) or
     (fullName/text[not(matches(@Image, "pkl_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="Picklist"]) or
     (fullName/text[not(matches(@Image, "pkm_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="MultiselectPicklist"]) or
     (fullName/text[not(matches(@Image, "cur_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="Currency"]) or
     (fullName/text[not(matches(@Image, "pct_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="Percent"]) or
     (fullName/text[not(matches(@Image, "fcur_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="Currency"] and formula) or
     (fullName/text[not(matches(@Image, "rcnt_([A-Z][a-z0-9]+)+__c"))] and type/text[@Image="Summary"] and summaryOperation/text[@Image="count"]) 
]
                ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="UnrestrictedPasswordPolicy"
    language="xml"
    message="It is a high security risk for any profile to have &quot;No Restriction&quot; as the password complexity requirement."
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <priority>3</priority>
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                //SecuritySettings[ passwordPolicies/complexity/text[@Image='No restriction'] ]
                ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="TooShortPasswordPolicy"
    language="xml"
    message="The default value for the password length is 8 characters. Less than 8 characters is not secure."
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <priority>3</priority>
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                //SecuritySettings[ passwordPolicies/minimumPasswordLength/text[@Image<'8'] ]
                ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="ModifyAllOnSysAdminProfile"
    language="xml"
    message="Only Admins can view and modify all data, if any other profile get these permissions, they could manipulate records that shouldn't"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <priority>3</priority>
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                //Profile[ (userPermissions/name/text[@Image='ModifyAllData'] or userPermissions/name/text[@Image='ViewAllData']) and pmd:fileName()!='System Administrator' and userPermissions/enabled/text[@Image='true'] ]
                ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="ModifyAllOnPermSet"
    language="xml"
    message="Allowing this user permission can give access and ability to modify sensitive data."
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <priority>3</priority>
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                //PermissionSet[ userPermissions/name/text[@Image='ModifyAllData'] and userPermissions/enabled/text[@Image='true'] ]
                ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="ViewAllOnPermSet"
    language="xml"
    message="Allowing this user permission can give access to sensitive data."
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <priority>3</priority>
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                //PermissionSet[ userPermissions/name/text[@Image='ViewAllData'] and userPermissions/enabled/text[@Image='true'] ]
                ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="ManageUsersByNonSysAdmins"
    language="xml"
    message="Managing users need to be limited to System Administrator Profile only."
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <priority>3</priority>
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                //Profile[ pmd:fileName()!='System Administrator' and userPermissions/name/text[@Image='ManageUsers'] ]
                ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="TooLongSessionTimeout"
    language="xml"
    message="Allowing access to an inactive session for more than 12 hours is a security risk."
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <priority>3</priority>
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                //SecuritySettings[ sessionSettings/sessionTimeout/text[@Image='24 hours of inactivity'] or sessionSettings/sessionTimeout/text[@Image='12 hours of inactivity'] ]
                ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="PasswordsNeverExpire"
    language="xml"
    message="Passwords need to expire every 90 days for security."
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <priority>3</priority>
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                //SecuritySettings[ passwordPolicies/expiration/text[@Image='Never'] or passwordPolicies/expiration/text[@Image='SixMonths'] or passwordPolicies/expiration/text[@Image='OneYear'] ]
                ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="ViewSetupByNonSysAdmins"
    language="xml"
    message="Exposing the setup menu to non-authorized users."
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <priority>3</priority>
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                //Profile[ pmd:fileName()!='System Administrator' and userPermissions/enabled/text[@Image='true'] and userPermissions/name/text[@Image='ViewSetup'] ]
                ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="ApexClassTriggerPrefixNCS"
    language="xml"
    message="Apex Class/Trigger API name should have prefix as NCS_"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <priority>5</priority>
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                    //ApexClass[not(starts-with(pmd:fileName(),"NCS_")) and not(contains(pmd:fileName(),"TriggerHandler"))] 
                    | 
                    //ApexTrigger[not(starts-with(pmd:fileName(),"NCS_")) and not(contains(pmd:fileName(),"TriggerHandler"))] 
                ]]>                </value>
            </property>
        </properties>
    </rule>
    <rule
    name="LWCAPINameSuffixNCS"
    language="xml"
    message="LWC API name should have suffix as _NCS"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <priority>2</priority>
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                    //LightningComponentBundle[not(ends-with(pmd:fileName(),"_NCS.js-meta.xml"))] 
                ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="CustomFieldNameShouldBePrefixedwithNCS_"
    language="xml"
    message="Custom fields should be prefixed with NCS_"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                    //CustomField/fullName/text[ (ends-with(@Image,"__c")) and not(starts-with(pmd:fileName(),"NCS_")) ]
                ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="CustomObjectNameShouldBePrefixedwithNCS_"
    language="xml"
    message="Custom object should be prefixed with NCS_"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                //CustomObject[ (ends-with(pmd:fileName(),"__c.object-meta.xml")) and not(starts-with(pmd:fileName(),"NCS_")) ] 
            ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="FlowNameShouldBePrefixedwithNCS_"
    language="xml"
    message="Flows should be prefixed with NCS_"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
            //Flow[ not(starts-with(pmd:fileName(),"NCS_")) ] 
        ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="ProfileNameShouldBePrefixedwithNCS_"
    language="xml"
    message="Profile name should be prefixed with NCS_"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
            //Profile[ not(starts-with(pmd:fileName(),"NCS_")) and (pmd:fileName()!='Admin.profile-meta.xml') and  (pmd:fileName()!='Minimum Access - Salesforce.profile-meta.xml') ] 
        ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="PermissionSetNameShouldBePrefixedwithNCS_"
    language="xml"
    message="Permission Set name should be prefixed with NCS_"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
        //PermissionSet[ not(starts-with(pmd:fileName(),"NCS_")) ] 
    ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="PageLayoutNameShouldBePrefixedwithNCS"
    language="xml"
    message="Page Layout name should be prefixed with 'NCS '"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
        //Layout/summaryLayout[ (boolean(masterLabel)) and not(contains(pmd:fileName(),"-NCS")) ]
    ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="LightningPageShouldBePrefixedwithNCS_"
    language="xml"
    message="Lightning Page Dev Name should be prefixed with NCS_"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
        //FlexiPage[ not(starts-with(pmd:fileName(),"NCS_")) ] 
    ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="ApprovalProcessNameShouldBePrefixedwithNCS_"
    language="xml"
    message="Approval Process File Name should be prefixed with NCS_"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
        //ApprovalProcess[ not(matches(pmd:fileName(),".*NCS_.*")) ] 
    ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="CustomLabelNameShouldNOTBePrefixedwithNCS_"
    language="xml"
    message="Custom Label API Name should NOT be prefixed with NCS_"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
        //CustomLabels/labels/fullName/text[ (starts-with(@Image,"NCS_")) ] 
    ]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="EmailTemplateShouldNOTBePrefixedwithNCS_"
    language="xml"
    message="Email Template API Name should NOT be prefixed with NCS_"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
    //EmailTemplate[ (starts-with(pmd:fileName(),"NCS_")) ] 
]]>                </value>
            </property>
        </properties>
    </rule>

    <rule
    name="SharingRulesShouldBePrefixedwithNCS_"
    language="xml"
    message="Sharing Rules API Name should be prefixed with NCS_"
    class="net.sourceforge.pmd.lang.rule.XPathRule"
  >
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value
        ><![CDATA[
                //SharingRules[ sharingCriteriaRules/fullName/text[ not(starts-with(@Image,"NCS_")) ] ]
]]>                </value>
            </property>
        </properties>
    </rule>

</ruleset>
