# Unique name for this workflow
name: Validate PR

# Definition when the workflow should run
on:
    # The workflow will run whenever an event happens on a pull request
    pull_request:
      # The events are that a PR is opened, or when a commit is pushed
      # to a branch that has an existing pull request
      types: [opened, synchronize,reopened]
      # The branches filter allows to specify that this workflow should only
      # run if the branch name is "develop". This way we prevent this workflow
      # from running when PRs are opened on other branches
      branches: [ UAT ] #change this name for the branch that will be the target branch
      # We only care about changes to the force-app directory, which is the
      # root directory of the sfdx project. This prevents the job from running
      # when changing non-salesforce files (like this yml file).
      paths:
        - 'force-app/**'
            

# Jobs to be executed when the above conditions are met
jobs:
    # This is the name of the job. You can give it whatever name you want
    validate-pull-request:
        # As mentioned in the blog post, this job runs inside a VM. Here we
        # can specify which OS this VM should run on. 
        # In this case, we are going to run our commands on the latest version
        # of ubuntu
        runs-on: ubuntu-latest
        if: ${{ github.actor != 'dependabot[bot]' }}
        steps:
            # Now we install nodejs in the VM, and specify version 14
            - uses: actions/setup-node@v4
              with:
                node-version: '20'

            # The idea is that the VM can access your remote repository
            # because your repository is an sfdx project.
            # This is a default action that allows us to enter the root 
            # directory of the repository

            # Make sure to specify fetch-depth:0. This allows us to
            # access previous commits that have been pushed to the repository.

            # We'll need this later when we try to figure out which metadata has 
            # changed between commits, so that we can only deploy that metadata
            # to the destination org

            - name: 'Checkout source code'
              uses: actions/checkout@v4
              with:
                fetch-depth: 0
                              
            # Now Install Salesforce CLI
            - name: 'Install Salesforce CLI'
              run: |
                  npm install -g @salesforce/cli
                  sf version

            # Install Git Delta plugin (compatible with sf)
            - name: 'Installing sfdx-git-delta plugin'
              run: |
                  echo y | sf plugins install sfdx-git-delta
                  sf plugins

            # Install java as it is required for the next step
            - name: 'Installing java'
              run: |
                sudo apt-get update
                sudo apt install default-jdk

            # Install SFDX scanner
            - name: 'Installing SFDX scanner'
              run: echo y | sf plugins install @salesforce/sfdx-scanner

            - name: Install Flow Scanner Plugin
              run: |
                  echo y | sf plugins install lightning-flow-scanner
                  sf plugins

            # We use SFDX Git Delta to create a directory with only the metadata that has changed.
            # this allows us to deploy only those changes, as opposed to deploying the entire branch. 
            # This helps reducing deployment times
            - name: 'Create delta packages for changed metadata'
              run: |
                  mkdir -p changed-sources

                  echo "Generating delta..."
                  sf sgd source delta \
                    --to "${{ github.event.pull_request.head.sha }}" \
                    --from "${{ github.event.pull_request.base.sha }}" \
                    --output changed-sources/ \
                    --generate-delta \
                    --source force-app/

                  echo ""
                  echo "======================================"
                  echo "üìÇ CONTENTS OF changed-sources"
                  echo "======================================"

                  if [ -d "changed-sources" ]; then
                    find changed-sources -type f
                  else
                    echo "‚ùå changed-sources directory not found."
                  fi

                  echo ""
                  echo "======================================"
                  echo "üì¶ PACKAGE.XML (if generated)"
                  echo "======================================"

                  if [ -f "changed-sources/package/package.xml" ]; then
                    cat changed-sources/package/package.xml
                  else
                    echo "No package.xml generated."
                  fi

            # Now we can use the sfdx scanner to scan the code in the delta directory
            # The output of the scan is stored in a file called apexScanResults.sarif

            # The .sarif file can later be uploaded to github, so that we can see the 
            # results of the scan directly from the PR.

            # Runs PMD ruleset. This task will fail if there is any rule that is violated.
            # We need to update ~/.sfdx-scanner/Config.json to make sure PMD scans -meta.xml files
            # We have defined custom Apex rules and custom XML Metadata rules that we should add as rules in PMD scanner
            - name: Apex Code + Metadata Best Practices scanning using PMD. This step will FAIL if there is any critical coding standards not met
              run: |
                echo "Adding custom XML rules..."
                sf scanner rule add --language xml --path "./scripts/pmd/category/xml/xml_custom_rules.xml"

                echo "Adding custom Apex rules..."
                sf scanner rule add --language apex --path "./scripts/pmd/category/apex/apex_custom_rules.xml"

                echo "List of rules being used:"
                sf scanner rule list

                # Allow scanning of -meta.xml files
                sed -i -e 's+"!\*\*/\*-meta.xml"+"\*\*/\*-meta.xml"+g' ~/.sfdx-scanner/Config.json || true

                echo "Executing PMD Scan on changed files..."
                if [ -d "changed-sources/force-app" ]; then
                  sf scanner run \
                    --target "changed-sources/force-app/" \
                    --pmdconfig "./scripts/pmd/rulesets/critical_scan.xml" \
                    --severity-threshold 1 \
                    --engine pmd
                else
                  echo "No changed metadata to scan."
                fi

            # Runs Flow Scan. This task will fail if there is any rule that is violated
            - name: Salesforce Flow Scan. This step will FAIL if there is any critical violation of governor limits hit in Flows
              run: |
                sf flow scan -d "changed-sources/force-app/"

            # Runs ESLint rules. This task will fail if there is any rule that is violated.
            - name: LWC Best Practices scanning using ESLint. This step will FAIL if there is any critical coding standards not met
              run: |
                npm dedupe

                echo "Executing ESLint Scan on changed LWC files..."
                sf scanner run \
                  --target "changed-sources/force-app/**/*.js" \
                  --eslintconfig "./scripts/eslint/.eslintrc.json" \
                  --severity-threshold 1 \
                  --engine eslint-lwc


